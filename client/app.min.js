"use strict";function reloadSchematics(){axios.get(uploaderApiURL+"/schematics?"+Date.now()).then(function(e){schFilesHelper.updateData(e.data)})["catch"](function(e){console.log(e)})}function uploadSchematicFile(e,t,a){var o=new FormData;for(var l in t)o.append(l,t[l]);o.append("sch_file",e),axios.post(uploaderApiURL+"/schematics/upload",o).then(function(e){setTimeout(function(){return $("#sch-files").bootstrapTable("refresh")}),a&&"function"==typeof a&&a(null,e)})["catch"](function(e){console.log(e),a&&"function"==typeof a&&a(e,null)})}function deleteSchematicFile(e,t){var a=new FormData;a.append("delete_key",getHashedDeleteKey(t)),axios["delete"](uploaderApiURL+"/schematics/"+e,{data:a}).then(function(e){reloadSchematics(),setTimeout(function(){return swal(e.data.file.filename+"を削除しました","","success")},500)})["catch"](function(t){console.log(t),setTimeout(function(){return swal(e+"の削除に失敗しました","挙動おかしい時は鯖管に教えてあげてね","error")},500)})}function getHashedDeleteKey(e){for(var t=CryptoJS.SHA256(e),a="",o=0;o<t.words.length;o++)a+=(t.words[o]>>>0).toString(16);return a}function loadSUITemplate(){axios("./sch-upload-item-template.html").then(function(e){schUploadItemTemplate=$(e.data)})}function renderOutput(e){loadSUITemplate();for(var t,a=[],o=0;t=e[o];o++){var l=schUploadItemTemplate.clone();l.data("id",o),$("p.filename strong",l).text(escapeHtml(t.name)),$(".form-group.title label",l).attr("for",o+"-title"),$(".form-group.title input",l).attr("id",o+"-title"),$(".form-group.description label",l).attr("for",o+"-description"),$(".form-group.description textarea",l).attr("id",o+"-description"),$(".form-group.delete-key label",l).attr("for",o+"-delete-key"),$(".form-group.delete-key input",l).attr("id",o+"-delete-key"),a.push(l)}$("output#list").html('<ul class="container-fluid"></ul>'),$("output#list ul").append(a),$(".sch-upload-items input[name=title]").on("blur keypress keyup",function(){$(this).val().length>0?($(this).parents(".form-group").removeClass("has-danger"),$(this).removeClass("form-control-danger"),$(this).parents(".sch-upload-items").find("button.upload").removeAttr("disabled")):($(this).parents(".form-group").addClass("has-danger"),$(this).addClass("form-control-danger"),$(this).parents(".sch-upload-items").find("button.upload").attr("disabled","disabled"))}).trigger("blur"),$(".sch-upload-items button.upload").on("click",function(){var e=$(this).parents(".sch-upload-items"),t=e.data("id"),a={title:$("input[name=title]",e).val(),description:$("textarea[name=description]",e).val()},o=$("input[name=delete_key]",e).val();o&&""!=o&&(a.delete_key=getHashedDeleteKey(o)),$("button",e).attr("disabled","disabled"),uploadSchematicFile(uploadFilesCache[t],a,function(a){a?($("button",e).removeAttr("disabled"),console.log("id"+t+"がアップロードエラー起こしてます")):(document.getElementById("list").innerHTML="",uploadFilesCache.splice(t,1),renderOutput(uploadFilesCache))})}),$(".sch-upload-items button.cancel").on("click",function(){var e=$(this).parents(".sch-upload-items").data("id");document.getElementById("list").innerHTML="",uploadFilesCache.splice(e,1),renderOutput(uploadFilesCache)})}function handleFileSelect(e){this.className="",e.stopPropagation(),e.preventDefault();for(var t,a=0;t=e.dataTransfer.files[a];a++)uploadFilesCache.push(t);renderOutput(uploadFilesCache)}function handleDragOver(e){this.className="hover",e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="link"}function handleDragLeave(){this.className=""}function startUTDisplay(){null==schUTUpdateTimer&&(schUTUpdateTimer=setInterval(function(){if(1>lastUpdateTime)schUTDisplay.textContent="";else if(Date.now()-lastUpdateTime>36e5)schUTDisplay.innerHTML='<span class="text-warning">下記のリストは1時間以上更新されていません。</span>',clearInterval(schUTUpdateTimer),schUTUpdateTimer=null;else{var e=Math.floor((Date.now()-lastUpdateTime)/1e3);e>300?e='<span class="text-warning">'+e+"秒</span>":e+="秒",schUTDisplay.innerHTML="最終更新から "+e+" 経過しています。"}},500))}function escapeHtml(e){var t={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};return e.replace(/[&"<>]/g,function(e){return t[e]})}var uploaderApiURL="./api",lastUpdateTime=-1,uploadFilesCache=[],schUploadItemTemplate=null,dropZone=document.getElementById("drop-zone");dropZone.addEventListener("dragover",handleDragOver,!1),dropZone.addEventListener("dragleave",handleDragLeave,!1),dropZone.addEventListener("drop",handleFileSelect,!1),$("#sch-files").bootstrapTable({toolbar:"#sch-toolbar",sortName:"modified_date",sortOrder:"desc",pagination:!0,search:!0,onResetView:function(){new Clipboard(".sch-command-copy",{text:function(e){return"//schem load "+$(e).data("filename")}}),$(".sch-file-delete").on("click",function(){var e=this;swal({title:"削除確認",text:"<strong>"+$(this).data("filename")+'</strong>を削除してもよろしいですか？<p><small style="font-size:9pt">※ 未記入の場合は削除キー未登録のアイテムのみ削除できます。</small></p>',type:"input",html:!0,customClass:"sa-delete-key-input",showCancelButton:!0,cancelButtonText:"キャンセル",confirmButtonColor:"#DD6B55",confirmButtonText:"削除するよ!",inputPlaceholder:"削除キーを入力してください。"},function(t){0!=t&&deleteSchematicFile($(e).data("filename"),t)})})},columns:[{title:"名前",field:"title",sortable:!0},{title:"ファイル名",field:"filename","class":"small",sortable:!0},{title:"更新日時",field:"modified_date","class":"small",sortable:!0,formatter:function(e){if(!e||1>e)return"";var t=new Date(e);return[t.getFullYear(),t.getMonth()+1,t.getDate()].join("/")+" "+t.toLocaleTimeString()}},{title:"詳細",field:"description","class":"small"},{title:"操作",field:"dropdown",formatter:function(e,t){var a=uploaderApiURL+"/schematics/"+t.filename+"/download",o=$("<div></div>");return o.append('<div class="btn-group btn-group-sm"></div>'),$(".btn-group",o).append('<button type="button" class="btn btn-secondary btn-no-outline sch-command-copy" data-filename="'+t.filename+'"><small>コマンドをコピー</small><i class="fa fa-clipboard" aria-hidden="true"></i></button>'),$(".btn-group",o).append('<button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="sr-only">Toggle Dropdown</span></button>'),$(".btn-group",o).append('<div class="dropdown-menu"></div>'),$(".dropdown-menu",o).append('<h6 class="dropdown-header">その他操作</h6>'),$(".dropdown-menu",o).append('<a class="dropdown-item" href="'+a+'">ダウンロード <i class="fa fa-download" aria-hidden="true" /></a>'),$(".dropdown-menu",o).append('<a class="dropdown-item sch-file-delete" href="#" data-filename="'+t.filename+'">削除 <i class="fa fa-trash" aria-hidden="true" /></a>'),o.html()}}],onRefresh:function(){reloadSchematics(),lastUpdateTime=Date.now(),startUTDisplay()}}),$("#sch-files").bootstrapTable("refresh"),$("#sch-toolbar > button.refresh").on("click",function(){$("#sch-toolbar > button.refresh").attr("disabled","disabled"),$("#sch-files").bootstrapTable("refresh"),setTimeout(function(){return $("#sch-toolbar > button.refresh").removeAttr("disabled")},1e3)}),loadSUITemplate();var schUTDisplay=$("#sch-toolbar > span.updated-time")[0],schUTUpdateTimer=null;window.schFilesHelper={updateData:function(e){var t=$("#sch-files");t.bootstrapTable("removeAll"),e.forEach(function(e){t.bootstrapTable("append",Object.assign({title:"",filename:"",upload_date:0,description:"",dropdown:""},e))})}};
//# sourceMappingURL=app.min.js.map