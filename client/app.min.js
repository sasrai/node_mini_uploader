"use strict";function reloadSchematics(){axios.get(uploaderApiURL+"/schematics?"+Date.now()).then(function(e){schFilesHelper.updateData(e.data)})["catch"](function(e){console.log(e)})}function uploadSchematicFile(e,t,a){var l=new FormData;for(var o in t)l.append(o,t[o]);l.append("sch_file",e),axios.post(uploaderApiURL+"/schematics/upload",l).then(function(e){setTimeout(function(){return $("#sch-files").bootstrapTable("refresh")}),a&&"function"==typeof a&&a(null,e)})["catch"](function(e){console.log(e),a&&"function"==typeof a&&a(e,null)})}function renderOutput(e){for(var t,a=[],l=0;t=e[l];l++)a.push('<div class="sch-upload-items col-xs-12 col-sm-12 col-md-6 col-lg-4" data-id='+l+'><div class="border-box">','<p class="filename"><strong>'+escape(t.name)+"</strong></p>",'<div class="container-fluid">','<div class="form-group">','<label for="'+l+'-title">タイトル</label>','<input class="form-control" name="title" id="'+l+'-title" placeholder="表示タイトルを入力してください(必須)">',"</div>",'<div class="form-group">','<label for="'+l+'-description">詳細</label>','<textarea class="form-control" name="description" id="'+l+'-description" rows="2" placeholder="ファイルの説明分を入力してください(任意)"></textarea>',"</div>",'<div class="form-group">','<label for="'+l+'-delete_key">削除キー(処理未実装)</label>','<input class="form-control" name="delete_key" id="'+l+'-delete_key" placeholder="削除キー(任意)">',"</div>",'<div class="btn-group btn-block" role="group" aria-label="Schematics control">','<button type="button" class="btn btn-info upload">アップロード <i class="fa fa-upload" aria-hidden="true"></i></button>','<button type="button" class="btn btn-secondary cancel">キャンセル</button>',"</div>","</div>","</div></div>");document.getElementById("list").innerHTML='<ul class="container-fluid">'+a.join("")+"</ul>",$(".sch-upload-items input[name=title]").on("blur keypress keyup",function(){$(this).val().length>0?($(this).parents(".form-group").removeClass("has-danger"),$(this).removeClass("form-control-danger"),$(this).parents(".sch-upload-items").find("button.upload").removeAttr("disabled")):($(this).parents(".form-group").addClass("has-danger"),$(this).addClass("form-control-danger"),$(this).parents(".sch-upload-items").find("button.upload").attr("disabled","disabled"))}).trigger("blur"),$(".sch-upload-items button.upload").on("click",function(){var e=$(this).parents(".sch-upload-items"),t=e.data("id"),a={title:$("input[name=title]",e).val(),description:$("textarea[name=description]",e).val()},l=$("input[name=delete_key]",e).val();if(l&&""!=l){for(var o=CryptoJS.SHA256(l),n="",s=0;s<o.words.length;s++)n+=(o.words[s]>>>0).toString(16);a.delete_key=n}$("button",e).attr("disabled","disabled"),uploadSchematicFile(uploadFilesCache[t],a,function(a){a?($("button",e).removeAttr("disabled"),console.log("id"+t+"がアップロードエラー起こしてます")):(document.getElementById("list").innerHTML="",uploadFilesCache.splice(t,1),renderOutput(uploadFilesCache))})}),$(".sch-upload-items button.cancel").on("click",function(){var e=$(this).parents(".sch-upload-items").data("id");document.getElementById("list").innerHTML="",uploadFilesCache.splice(e,1),renderOutput(uploadFilesCache)})}function handleFileSelect(e){this.className="",e.stopPropagation(),e.preventDefault();for(var t,a=0;t=e.dataTransfer.files[a];a++)uploadFilesCache.push(t);renderOutput(uploadFilesCache)}function handleDragOver(e){this.className="hover",e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="link"}function handleDragLeave(){this.className=""}function startUTDisplay(){null==schUTUpdateTimer&&(schUTUpdateTimer=setInterval(function(){if(1>lastUpdateTime)schUTDisplay.textContent="";else if(Date.now()-lastUpdateTime>36e5)schUTDisplay.innerHTML='<span class="text-warning">下記のリストは1時間以上更新されていません。</span>',clearInterval(schUTUpdateTimer),schUTUpdateTimer=null;else{var e=Math.floor((Date.now()-lastUpdateTime)/1e3);e>300?e='<span class="text-warning">'+e+"秒</span>":e+="秒",schUTDisplay.innerHTML="最終更新から "+e+" 経過しています。"}},500))}var uploaderApiURL="./api",lastUpdateTime=-1,uploadFilesCache=[],dropZone=document.getElementById("drop-zone");dropZone.addEventListener("dragover",handleDragOver,!1),dropZone.addEventListener("dragleave",handleDragLeave,!1),dropZone.addEventListener("drop",handleFileSelect,!1),$("#sch-files").bootstrapTable({toolbar:"#sch-toolbar",sortName:"modified_date",sortOrder:"desc",pagination:!0,search:!0,columns:[{title:"名前",field:"title",sortable:!0},{title:"ファイル名",field:"filename","class":"small",sortable:!0},{title:"更新日時",field:"modified_date","class":"small",sortable:!0,formatter:function(e){if(!e||1>e)return"";var t=new Date(e);return[t.getFullYear(),t.getMonth()+1,t.getDate()].join("/")+" "+t.toLocaleTimeString()}},{title:"詳細",field:"description","class":"small"},{title:"ダウンロード",field:"download",formatter:function(e,t){var a=uploaderApiURL+"/schematics/"+t.filename+"/download";return'<a class="btn btn-primary btn-info btn-sm" href="'+a+'">ダウンロード <i class="fa fa-download" aria-hidden="true" /></a>'}}],onRefresh:function(){reloadSchematics(),lastUpdateTime=Date.now(),startUTDisplay()}}),$("#sch-files").bootstrapTable("refresh"),$("#sch-toolbar > button.refresh").on("click",function(){$("#sch-toolbar > button.refresh").attr("disabled","disabled"),$("#sch-files").bootstrapTable("refresh"),setTimeout(function(){return $("#sch-toolbar > button.refresh").removeAttr("disabled")},1e3)});var schUTDisplay=$("#sch-toolbar > span.updated-time")[0],schUTUpdateTimer=null;window.schFilesHelper={updateData:function(e){var t=$("#sch-files");t.bootstrapTable("removeAll"),e.forEach(function(e){t.bootstrapTable("append",Object.assign({title:"",filename:"",upload_date:0,description:"",download:""},e))})}};
//# sourceMappingURL=app.min.js.map