"use strict";
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),SchematicsAPI=function(){function e(t){_classCallCheck(this,e),this.apiURL=t+"/schematics"}return _createClass(e,[{key:"reload",value:function(e){axios.get(this.apiURL+"?"+Date.now()).then(function(t){e&&"function"==typeof e&&e(null,t.data)})["catch"](function(t){console.log(t),e&&"function"==typeof e&&e(t,null)})}},{key:"getDownloadURL",value:function(e){return this.apiURL+"/"+e+"/download"}},{key:"uploadFile",value:function(e,t,a){var n=new FormData;for(var l in t)n.append(l,t[l]);n.append("sch_file",e),axios.post(this.apiURL+"/upload",n).then(function(e){a&&"function"==typeof a&&a(null,e)})["catch"](function(e){console.log(e),a&&"function"==typeof a&&a(e,null)})}},{key:"deleteFile",value:function(e,t,a){var n=new FormData;n.append("delete_key",getHashedDeleteKey(t)),axios["delete"](this.apiURL+"/"+e,{data:n}).then(function(e){a&&"function"==typeof a&&a(null,e)})["catch"](function(e){console.log(e),a&&"function"==typeof a&&a(e,null)})}}]),e}(),schematicsAPI=new SchematicsAPI("./api");
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),__UploadSchematicItem_Template=null,UploadSchematicItem=function(){function e(t,a){var n=arguments.length<=2||void 0===arguments[2]?null:arguments[2],l=arguments.length<=3||void 0===arguments[3]?!1:arguments[3];if(_classCallCheck(this,e),!e.Template)throw new Error("Unloaded template data.");this.template=$(e.Template.clone()),this.newFilename=null,this.DuplicateFile=n,this.uploading=!1,this.enabledDeleteKey=l,arguments.length>0&&(this.Id=t),arguments.length>1&&(this.filedata=a,this.Filename=a.name),arguments.length>2&&(this.isDuplicateFile=!1),this.setLocalEventHandler()}return _createClass(e,null,[{key:"loadSUITemplate",value:function(){axios("./sch-upload-item-template.html?"+Date.now()).then(function(t){e.Template=$($(t.data).get(0))})}},{key:"Template",get:function(){return __UploadSchematicItem_Template},set:function(e){__UploadSchematicItem_Template=e}}]),_createClass(e,[{key:"getJQueryObject",value:function(){return this.template.data("id",this.Id),$("p.filename strong",this.template).text(escapeHtml(this.Filename)),$(".form-group.title label",this.template).attr("for",this.Id+"-title"),$(".form-group.title input",this.template).attr("id",this.Id+"-title"),$(".form-group.description label",this.template).attr("for",this.Id+"-description"),$(".form-group.description textarea",this.template).attr("id",this.Id+"-description"),$(".form-group.delete-key label",this.template).attr("for",this.Id+"-delete-key"),$(".form-group.delete-key input",this.template).attr("id",this.Id+"-delete-key"),$("input[name=title]",this.template).trigger("blur"),this.updateButtonStatus(),this.template}},{key:"performUpload",value:function(e,t){var a=this;schematicsAPI.uploadFile(e,t,function(e){e?a.template.trigger("schup:uploaderror",{id:a.id,title:a.Title,filename:a.Filename,Error:e}):a.template.trigger("schup:uploaded",{id:a.id,title:a.Title,filename:a.Filename})})}},{key:"updateButtonStatus",value:function(){this.canUploadable?$("button.upload",this.template).removeAttr("disabled"):$("button.upload",this.template).attr("disabled","disabled"),this.canUploadCancel?$("button.cancel",this.template).removeAttr("disabled"):$("button.cancel",this.template).attr("disabled","disabled")}},{key:"setLocalEventHandler",value:function(){var e=this;$("input[name=title]",this.template).on("blur keypress keyup",function(t){return e.handleTitleValidate(t)}),$("button.upload",this.template).on("click",function(t){return e.handleUploadButtonClick(t)}),$("button.cancel",this.template).on("click",function(t){return e.handleCancelButtonClick(t)}),$("input[name=overwrite]",this.template).on("change",function(t){return e.handleOverwriteCheckChanged(t)})}},{key:"handleTitleValidate",value:function(){this.isValidatedTitle?($(".form-group.title",this.template).removeClass("has-danger"),$("input[name=title]",this.template).removeClass("form-control-danger")):($(".form-group.title",this.template).addClass("has-danger"),$("input[name=title]",this.template).addClass("form-control-danger")),this.updateButtonStatus()}},{key:"handleOverwriteCheckChanged",value:function(){this.updateButtonStatus()}},{key:"handleCancelButtonClick",value:function(){this.template.trigger("schup:canceled",{id:this.id})}},{key:"handleUploadButtonClick",value:function(){var e=this;this.uploading=!0,this.updateButtonStatus();var t={title:this.Title,description:this.Description},a=this.DeleteKey;a&&""!=a&&(t.delete_key=getHashedDeleteKey(a)),this.EnabledDeleteKey?showDeleteKeyDialog(this.Title,!0,function(a){t.overwrite_key=getHashedDeleteKey(a),e.performUpload(e.filedata,t)}):this.performUpload(this.filedata,t),this.uploading=!1,this.updateButtonStatus()}},{key:"setEventCancel",value:function(e){this.template.on("schup:canceled",e)}},{key:"setEventUploaded",value:function(e){this.template.on("schup:uploaded",e)}},{key:"setEventUploadError",value:function(e){this.template.on("schup:uploaderror",e)}},{key:"canUploadable",get:function(){var e=!0;return this.isValidatedTitle||(e=!1),this.isDuplicated&&!this.isOverwrite&&(e=!1),this.isUploading&&(e=!1),e}},{key:"canUploadCancel",get:function(){var e=!0;return this.isUploading&&(e=!1),e}},{key:"isValidatedTitle",get:function(){return this.Title.length>0}},{key:"isDuplicated",get:function(){return!!this.duplicateFile}},{key:"isOverwrite",get:function(){return!!$("input[name=overwrite]:checked",this.template).val()}},{key:"isUploading",get:function(){return this.uploading}},{key:"Id",set:function(e){this.id=e},get:function(){return this.id}},{key:"Filename",set:function(e){this.newFilename=e},get:function(){return this.newFilename?this.newFilename:this.filedata.name}},{key:"Title",get:function(){return $("input[name=title]",this.template).val()}},{key:"Description",get:function(){return $("textarea[name=description]",this.template).val()}},{key:"DeleteKey",get:function(){return $("input[name=delete_key]",this.template).val()}},{key:"DuplicateFile",set:function(e){this.duplicateFile=e,this.isDuplicated?$("label.overwrite",this.template).show():$("label.overwrite",this.template).hide()}},{key:"EnabledDeleteKey",set:function(e){this.enabledDeleteKey=e},get:function(){return this.enabledDeleteKey}}]),e}();UploadSchematicItem.loadSUITemplate();
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),DragAndDropUploader=function(){function e(){_classCallCheck(this,e),this.schUploadItemTemplate=null,this.uploadFilesCache=[]}return _createClass(e,[{key:"handleFileSelect",value:function(e){e.target.className="",e.stopPropagation(),e.preventDefault();for(var t,a=0;t=e.originalEvent.dataTransfer.files[a];a++)this.uploadFilesCache.push(t);this.renderOutput()}},{key:"handleDragOver",value:function(e){e.target.className="hover",e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="link"}},{key:"handleDragLeave",value:function(){this.className=""}},{key:"initializer",value:function(){var e=this,t=$("#drop-zone");t.on("dragover",function(t){return e.handleDragOver(t)}),t.on("dragleave",function(t){return e.handleDragLeave(t)}),t.on("drop",function(t){return e.handleFileSelect(t)})}},{key:"renderOutput",value:function(){for(var e,t=this,a=[],n=SchematicsListController.GetFileInfos(),l=0;e=this.uploadFilesCache[l];l++){var o=new UploadSchematicItem(l,e);o.setEventCancel(function(e,a){t.uploadFilesCache.splice(a.id,1),t.renderOutput()}),o.setEventUploaded(function(e,a){SchematicsListController.ReloadList(),t.uploadFilesCache.splice(a.id,1),t.renderOutput(),swal(a.title+"のアップロードが完了しました","","success")}),o.setEventUploadError(function(e,t){var a="";403==t.Error.response.status&&(a="上書きが出来ませんでした。削除キーが一致しません。"),swal(t.title+"のアップロードに失敗しました。",a,"error")});var i=n.map(function(e){return e.name}).indexOf(e.name);i>=0&&(o.DuplicateFile=e,o.EnabledDeleteKey=n[i].enabledDeleteKey),a.push(o.getJQueryObject())}$("output#list").html('<ul class="container-fluid"></ul>'),$("output#list ul").append(a)}}]),e}(),dadUploader=new DragAndDropUploader;dadUploader.initializer();
"use strict";function getHashedDeleteKey(e){if(!e)return"";for(var t=CryptoJS.SHA256(e),a="",n=0;n<t.words.length;n++)a+=(t.words[n]>>>0).toString(16);return a}function escapeHtml(e){var t={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};return e.replace(/[&"<>]/g,function(e){return t[e]})}function getDateStringFromUTCMillis(e){var t=new Date(e);return[t.getFullYear(),t.getMonth()+1,t.getDate()].join("/")+" "+t.toLocaleTimeString()}function showDeleteKeyDialog(e,t,a){void 0===t&&(t=!1),2==arguments.length&&"function"==typeof t&&(a=t,t=!1);var n=t?"上書き":"削除";swal({title:n+"確認",text:"<strong>"+e+"</strong>を"+n+'してもよろしいですか？<p><small style="font-size:9pt">※ 未記入の場合は削除キー未登録のアイテムのみ'+n+"できます。</small></p>",type:"input",html:!0,customClass:"sa-delete-key-input",showCancelButton:!0,cancelButtonText:"キャンセル",confirmButtonColor:"#DD6B55",confirmButtonText:n+"するよ!",inputPlaceholder:"削除キーを入力してください。"},function(e){!1!==e&&"function"==typeof a&&a(e)})}
;"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function startUTDisplay(){null==schUTUpdateTimer&&(schUTUpdateTimer=setInterval(function(){if(lastUpdateTime<1)schUTDisplay.textContent="";else if(Date.now()-lastUpdateTime>36e5)schUTDisplay.innerHTML='<span class="text-warning">下記のリストは1時間以上更新されていません。</span>',clearInterval(schUTUpdateTimer),schUTUpdateTimer=null;else{var e=Math.floor((Date.now()-lastUpdateTime)/1e3);e>300?e='<span class="text-warning">'+e+"秒</span>":e+="秒",schUTDisplay.innerHTML="最終更新から "+e+" 経過しています。"}},500))}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();$("#sch-files").bootstrapTable({toolbar:"#sch-toolbar",sortName:"modified_date",sortOrder:"desc",pagination:!0,search:!0,onResetView:function(){new Clipboard(".sch-command-copy",{text:function(e){return"//schem load "+$(e).data("filename")}}),$(".sch-file-delete").on("click",function(){var e=$(this).data("filename");showDeleteKeyDialog(e,function(t){schematicsAPI.deleteFile(e,t,function(t,a){setTimeout(function(){t?swal(e+"の削除に失敗しました","挙動おかしい時は鯖管に教えてあげてね","error"):(swal(a.data.file.filename+"を削除しました","","success"),SchematicsListController.ReloadList())},500)})})})},columns:[{title:"名前",field:"title",sortable:!0},{title:"ファイル名",field:"filename","class":"small",sortable:!0},{title:"更新日時",field:"modified_date","class":"small",sortable:!0,formatter:function(e){return!e||1>e?"":getDateStringFromUTCMillis(e)}},{title:"詳細",field:"description","class":"small"},{title:"操作",field:"dropdown",formatter:function(e,t){var a=$("<div></div>");return a.append('<div class="btn-group btn-group-sm"></div>'),$(".btn-group",a).append('<button type="button" class="btn btn-secondary btn-no-outline sch-command-copy" data-filename="'+t.filename+'"><small>コマンドをコピー</small><i class="fa fa-clipboard" aria-hidden="true"></i></button>'),$(".btn-group",a).append('<button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="sr-only">Toggle Dropdown</span></button>'),$(".btn-group",a).append('<div class="dropdown-menu"></div>'),$(".dropdown-menu",a).append('<h6 class="dropdown-header">その他操作</h6>'),$(".dropdown-menu",a).append('<a class="dropdown-item" href="'+schematicsAPI.getDownloadURL(t.filename)+'">ダウンロード <i class="fa fa-download" aria-hidden="true" /></a>'),$(".dropdown-menu",a).append('<a class="dropdown-item sch-file-delete" href="#" data-filename="'+t.filename+'">削除 <i class="fa fa-trash" aria-hidden="true" /></a>'),a.html()}}],onRefresh:function(){schematicsAPI.reload(function(e,t){SchematicsListController.UpdateData(t),lastUpdateTime=Date.now(),startUTDisplay()})}});var schUTDisplay=$("#sch-toolbar > span.updated-time")[0],schUTUpdateTimer=null,SchematicsListController=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"TableInitialize",value:function(){e.ReloadList(),$("#sch-toolbar > button.refresh").on("click",function(){$("#sch-toolbar > button.refresh").attr("disabled","disabled"),e.ReloadList(),setTimeout(function(){return $("#sch-toolbar > button.refresh").removeAttr("disabled")},1e3)})}},{key:"ReloadList",value:function(){$("#sch-files").bootstrapTable("refresh")}},{key:"UpdateData",value:function(e){var t=$("#sch-files");t.bootstrapTable("removeAll"),e.forEach(function(e){t.bootstrapTable("append",Object.assign({title:"",filename:"",upload_date:0,description:"",dropdown:""},e))})}},{key:"GetFileInfos",value:function(){return $("#sch-files").bootstrapTable("getData").map(function(e){return{name:e.original_name,enabledDeleteKey:e.enabled_delete_key}})}}]),e}();SchematicsListController.TableInitialize();
"use strict";var lastUpdateTime=-1,schUploadItemTemplate=null;
//# sourceMappingURL=app.min.js.map